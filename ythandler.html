<!DOCTYPE html>
<html>
  <head>  </head>
  <body>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>

    <script>
        const waitUntil = (condition, checkInterval=100) => {
            return new Promise(resolve => {
                let interval = setInterval(() => {
                    if (!condition()) return;
                    clearInterval(interval);
                    resolve();
                }, checkInterval)
            });
        }
        const paramsString = window.location.search;
        const URLParams = new URLSearchParams(paramsString);
        const source = URLParams.get('v');
        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');
      
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
      
        var player;
    
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: source,
            host: ['https://www.youtube.com', 'https://www.youtube-nocookie.com'][Number(localStorage.getItem('host'))],
            playerVars: {
              'playsinline': 1
            },
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
            }
          });
        }
    
        // 4. The API will call this function when the video player is ready.
        async function onPlayerReady(event) {
          if (localStorage.getItem('ytTime:' + source)) {
              player.seekTo(localStorage.getItem('ytTime:' + source, true));
          }
        }
    
        let timeint;
        let ended = false;
        let started;
        function onPlayerStateChange(event) {
          if (event.data == YT.PlayerState.ENDED)  {
            ended = true;
            clearInterval(timeint);
            eraseTime();
            return;
          }
          ended = false;
          if (event.data == YT.PlayerState.PLAYING) {
            timeint = setInterval(saveTime, 10000);
          } else {
            saveTime();
            clearInterval(timeint);
          }
  
        }
        function stopVideo() {
          player.stopVideo();
        }
        function saveTime() {
            localStorage.setItem('ytTime:' + source, player.getCurrentTime())
            console.log('time saved')
        }
        function eraseTime() {
            localStorage.removeItem('ytTime:' + source)
            console.log('time erased')
            console.log(localStorage.getItem('ytTime:' + source))
        }
        const iframe = document.getElementById('player');
        iframe.style.position = 'fixed';
        iframe.style.inset = 0;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        window.addEventListener('unload', (event) => {
            if (!ended) {
               saveTime();
            }
        });
        /*function terminateIframe() {
            const div = document.createElement('div')
            div.style.cssText = 'position: fixed; inset: 0; width: 100%; height: 100%;';
            const img = div.createElement('img')
        }*/
    </script>
  </body>
</html>
